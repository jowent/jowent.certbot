---

- name: certbot dependencies installed
  apt: pkg=software-properties-common state=present update_cache=yes

- name: Add certbot repository from PPA and install its signing key.
  apt_repository: repo='ppa:certbot/certbot'

- name: certbot and nginx plugin installed
  apt: pkg=python-certbot-nginx state=present update_cache=yes

- name: Make directory for nginx config backup
  file:
    path=/etc/nginx/sites-enabled-pre-certbot/
    state=directory
    owner=root
    group=root
    mode=0755

- name: backup existing nginx configuration
  copy: src={{ item }}
        remote_src=yes
        dest=/etc/nginx/sites-enabled-pre-certbot/
        owner=root
        group=root
        mode=0644
        force=no
  with_fileglob:
    - /etc/nginx/sites-enabled/*

# cronjobs already installed by the package!
